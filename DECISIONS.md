# Architecture Decisions

| Date | Topic | Decision | Rationale |
|------|-------|----------|-----------|
| 2026-02-07 | Embedding model | OpenAI `text-embedding-3-small` (1536 dims) | Best balance of cost ($0.01/1M tokens via Batch API), quality for Greek/English legal text, and Vectorize compatibility (max 1536 dims). `text-embedding-3-large` (3072 dims) showed 2x better cross-lingual matching but exceeds Vectorize dimension limit. |
| 2026-02-07 | Vector database | Cloudflare Vectorize (`cyprus-law-cases-search-revised` index) | Native Cloudflare integration (Worker bindings), no external infra, cosine similarity, metadata filtering. Replaced local ChromaDB. Index renamed from `cylaw-search` → `cyprus-law-cases-search` → `cyprus-law-cases-search-revised`. |
| 2026-02-07 | Ingestion method | OpenAI Batch API (`scripts/batch_ingest.py`) | 50% cheaper than synchronous API ($0.01 vs $0.02 per 1M tokens). Separate rate limits — no TPM throttling that plagued synchronous ingestion (~60 ch/s). Full 2.27M chunk ingestion completed in ~2 hours vs projected 5+ hours synchronous. |
| 2026-02-07 | Vectorize index name | `cyprus-law-cases-search-revised` | Evolved: `cylaw-search` → `cyprus-law-cases-search` → `cyprus-law-cases-search-revised` (re-embedding with contextual headers, jurisdiction, cleaned text). Old index `cyprus-law-cases-search` kept as fallback. |
| 2026-02-07 | Vector ID hashing | MD5 truncation for IDs >64 bytes | Vectorize enforces 64-byte max on vector IDs. Long doc_ids (e.g., deeply nested court paths) are hashed: `md5(doc_id)[:16] + "::" + chunk_index`. Full `doc_id` preserved in metadata for retrieval. |
| 2026-02-07 | ChromaDB status | Legacy / dev-only | ChromaDB (`chromadb_local`, `chromadb_openai`) contains vectors from original 9 courts only. Not updated with 6 new courts. Kept for offline local development but not used in production. |
| 2026-02-07 | Document storage | Cloudflare R2 (`cyprus-case-law-docs`) | Zero egress costs, native Worker binding, 149,886 .md files. Dev uses S3 HTTP API (real bucket), prod uses Worker binding. |
| 2026-02-07 | Frontend framework | Next.js 16 on Cloudflare Workers via @opennextjs/cloudflare | Server-side rendering, API routes co-located with frontend, native Cloudflare bindings (R2, Vectorize). |
| 2026-02-07 | Auth | Cloudflare Zero Trust (email OTP) | No custom auth code needed. Replaced password-based auth. |
| 2026-02-07 | Chunking method | RecursiveCharacterTextSplitter (2000 chars, 400 overlap) with contextual headers | ACL/NAACL 2025 research confirms semantic chunking does NOT justify computational cost over recursive. Current params: ~500 tokens/chunk, 20% overlap. |
| 2026-02-09 | Chunking improvements | Contextual headers, ΑΝΑΦΟΡΕΣ stripping, text cleaning, tail merge | Implemented all planned improvements: prepend header (Anthropic technique, -49% retrieval errors), strip cross-references, clean markdown/C1 noise, merge tail chunks < 500 chars. areiospagos reclassified as `court_level=foreign`. |
| 2026-02-09 | LLM query diversification | Facet-based query strategy with keyword overlap constraint | Old prompt: "do 3-5 different queries" → LLM paraphrased same phrase. New prompt: explicit facets (core concept, statute, synonym), anti-pattern example, keyword overlap rule. Hit rate 2% → 4% on niche query. |
| 2026-02-12 | Weaviate removal | Remove Weaviate experiment, keep Vectorize only | Weaviate (document-level, 3072d hybrid) found 0/4 A-docs and 0/6 B-docs on ground-truth query vs Vectorize 3/4 and 5/6. Not worth maintaining two backends. Will move to PostgreSQL + pgvector for hybrid search instead. |
| 2026-02-12 | MAX_SUMMARIZE_DOCS | Increase from 20 to 30 | Cap of 20 caused A1/A2 regression — passed reranker (score 5) but capped out. Restoring to 30 fixes it. Service Binding handles the load fine. |
| 2026-02-12 | Cohere rerank | Add Cohere rerank-v3.5 as primary reranker, GPT-4o-mini as fallback | Cross-encoder scores each doc independently (no batch noise). GPT-4o-mini reranker had batch noise: same doc scored 1 in one run, 5 in another depending on batch composition. Cohere uses HTTP fetch (no npm dep). |
| 2026-02-12 | Summarizer prompt | Decouple relevance from engagement level | Old prompt: engagement→relevance mapping (NOT ADDRESSED → NONE). New prompt: relevance = research value. MANDATORY OVERRIDES: foreign-law cases with cross-border elements ≥ MEDIUM. True A+B positive docs: 1 → 4. |
